<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<style>
    .box{
        display: block;
        width: 500px;
        height: 500px;
        border: 1px solid #ccc;
        margin: 60px;
    }
</style>
<!--<script src="fabric.js"></script>-->
<!--<script src="fabric1.4.js"></script>-->
<!--<script src="fabric1.6.js"></script>-->
<script src="fabric1.6-new.js"></script>
<!--<script src="loadHash.js"></script>-->
<script src="underscore.js"></script>
<script src="jquery.min.js"></script>

<body>

<canvas id="c" width="300" height="300"  style="border: 0px solid #ccc;width:400px;height:400px"></canvas>

<button type="button" id="test">1111</button>
<button type="button" id="test2">2222</button>
<button type="button" id="test33">3333</button>
<button type="button" id="test3">delete</button>
<button type="button" id="test4">border</button>


<script>




    window.onload = function () {


        var img01URL = 'https://img.alicdn.com/bao/uploaded/https://img.alicdn.com/imgextra/i4/1732912933/TB2Z63kXK38SeJjSZFPXXc_vFXa-1732912933.jpg';
        var img02URL = 'https://img.alicdn.com/bao/uploaded/https://img.alicdn.com/imgextra/i4/1732912933/TB2Z63kXK38SeJjSZFPXXc_vFXa-1732912933.jpg';
        var img03URL = 'https://img.alicdn.com/bao/uploaded/i4/1732912933/TB2T7WZc4Rzc1FjSZFPXXcGAFXa-1732912933.jpg';

        var cEl = document.getElementById('c');


        var canvas = new fabric.Canvas('c');

        //events
        canvas.observe("object:scaling", function (o) {
            console.log(o);
        });
        $(canvas.wrapperEl).on('mousewheel', function(e) {
            var target = canvas.findTarget(e);
            var delta = e.originalEvent.wheelDelta / 720;

            console.log(e);
            console.log(PUG);
            if (target) {

                target.scaleX += delta;
                target.scaleY += delta;

                // constrain

                if (target.scaleX < 0.1) {
                    target.scaleX = 0.1;
                    target.scaleY = 0.1;
                }
                // constrain
                if (target.scaleX > 10) {
                    target.scaleX = 10;
                    target.scaleY = 10;
                }

                console.log(target.scaleX, target.scaleY);
                target.setCoords();
                canvas.renderAll();
            }
        });


        // Note the use of the `originX` and `originY` properties, which we set
        // to 'left' and 'top', respectively. This makes the math in the `clipTo`
        // functions a little bit more straight-forward.
        var clipPoly = new fabric.Polygon([
            { x: 180, y: 10 },
            { x: 300, y: 50 },
            { x: 300, y: 180 },
            { x: 180, y: 220 }
        ], {
            originX: 'left',
            originY: 'top',
            fill: 'transparent', /* use transparent for no fill */
            selectionLineWidth: 2,
            strokeWidth: 2,
            selectionBorderColor :'red',
            selectable: false
        });
        // We give these `Rect` objects a name property so the `clipTo` functions can
        // find the one by which they want to be clipped.
        clipPoly.set({
            clipFor: 'pug'
        });
        canvas.add(clipPoly);


        var clipRect2 = new fabric.Polygon([
            { x: 10, y: 10 },
            { x: 150, y: 10 },
            { x: 150, y: 180 },
            { x: 10, y: 180 }
        ], {
            originX: 'left',
            originY: 'top',
            fill: "transparent",
//            strokeWidth: 0.75,
//            stroke: 'rgb(255,0,0)',
//            borderColor: 'red',
//            cornerColor: 'green',
//            transparentCorners: false,
            selectable: false
//            selectionBorderColor :'red',
//            selectable: false
        });
        // We give these `Rect` objects a name property so the `clipTo` functions can
        // find the one by which they want to be clipped.
        clipRect2.set({
            clipFor: 'logo'
        });
        canvas.add(clipRect2);
        canvas.moveTo(clipRect2, 200);

        function findByClipName(name) {
//            return _(canvas.getObjects()).where({
//                clipFor: name
//            }).first()

            return _(canvas.getObjects()).where({
                clipFor: name
            })[0]

        }

        // Since the `angle` property of the Image object is stored
        // in degrees, we'll use this to convert it to radians.
        function degToRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        var clipByName = function (ctx) {
            this.setCoords();
            var clipObj = findByClipName(this.clipName);
            var scaleXTo1 = (1 / this.scaleX);
            var scaleYTo1 = (1 / this.scaleY);
            var skewXReverse = - this.skewX;
            var skewYReverse = - this.skewY;
            ctx.save();

            var ctxLeft = -( this.width / 2 ) + clipObj.strokeWidth;
            var ctxTop = -( this.height / 2 ) + clipObj.strokeWidth;
            var ctxWidth = clipObj.width - clipObj.strokeWidth;
            var ctxHeight = clipObj.height - clipObj.strokeWidth;


            ctx.translate( ctxLeft, ctxTop );
            ctx.scale(scaleXTo1, scaleYTo1);
            ctx.transform(1, skewXReverse, skewYReverse, 1, 0, 0);
            ctx.rotate(degToRad(this.angle * -1));

            ctx.beginPath();

            var isPolygon = clipObj instanceof fabric.Polygon;
            // polygon cliping area
            var i;
            if(isPolygon)
            {
                // prepare points of polygon
                var points = [];
                for(i in clipObj.points)
                    points.push({
                        x: (clipObj.left + clipObj.width / 2) + clipObj.points[i].x - this.oCoords.tl.x,
                        y: (clipObj.top + clipObj.height / 2) + clipObj.points[i].y - this.oCoords.tl.y
                    });

                ctx.moveTo(points[0].x, points[0].y);
                for(i=1; i<points.length; ++i)
                {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.lineTo(points[0].x, points[0].y);
            }
            // rectangle cliping area
            else
            {
                ctx.rect(
                        clipObj.left - this.oCoords.tl.x,
                        clipObj.top - this.oCoords.tl.y,
                        clipObj.width,
                        clipObj.height
                );
            }

            ctx.closePath();

            ctx.restore();
        }


        cEl.width = 300;
        cEl.height = 300;
        cEl.style.width = '300px';
        cEl.style.height = '300px';

        var PUG = null;
        document.getElementById("test").onclick = function () {




            var pugImg = new Image();
            pugImg.onload = function (img) {
                PUG = new fabric.Image(pugImg, {
//                angle: 45,
//                width: 500,
//                height: 500,
                    left: 180,
                    top: 10,
//                scaleX: 0.3,
//                scaleY: 0.3,
                    borderColor: 'blue',
                    cornerColor: 'blue',
                    borderScaleFactor: 0.2,
                    clipName: 'pug',
                    clipTo: function(ctx) {
                        return _.bind(clipByName, PUG)(ctx)
                    }
                });
                canvas.add(PUG);
                canvas.moveTo(PUG, 30);
            };
            pugImg.src = img02URL;




        };

        document.getElementById("test2").onclick = function () {




            var logoImg = new Image();
            logoImg.onload = function (img) {
                var logo = new fabric.Image(logoImg, {
                    angle: 0,
//                width: 550,
//                height: 190,
                    left: 0,
                    top: 0,
//                scaleX: 0.25,
//                scaleY: 0.25,
                    clipName: 'logo',
                    clipTo: function(ctx) {
                        return _.bind(clipByName, logo)(ctx)
                    }
                });
                canvas.add(logo);
                canvas.moveTo(logo, 130);
                clipRect2.bringToFront(logo);
                canvas.renderAll();
            };
            logoImg.src = img01URL;



        };

        document.getElementById("test3").onclick = function () {

            canvas.remove(PUG);

        };

        document.getElementById("test4").onclick = function () {


            clipRect2.set({
                strokeWidth: 0.75,
                stroke: 'rgb(255,0,0)'
            })
            canvas.renderAll();

//            clipRect2.set("borderColor", "blue");
//            canvas.getActiveObject().setBackgroundColor('rgba(0,255,0,1)');

//            clipRect2.set("borderWidth", "2px");
//            clipRect2.set('borderColor', 'blue');
//            clipRect2.set('fill', 'blue');


//            clipRect2.set({
//                borderDashArray: [2, 2],
//                borderWidth:4,
//                borderColor: 'green',
//                cornerColor: 'blue',
//                cornerSize: 18
//            });
//            clipRect2.setBackgroundColor('rgba(255, 73, 64, 0.6)', canvas.renderAll.bind(canvas));

//            canvas.renderAll.bind(canvas)
//            canvas.renderAll();
        };

        document.getElementById("test33").onclick = function () {

            var tempImg = new Image();
            tempImg.onload = function (img) {
                var logo = new fabric.Image(tempImg, {
                    angle: 0,
//                width: 550,
//                height: 190,
                    left: 0,
                    top: 0,
//                scaleX: 0.25,
//                scaleY: 0.25,
                    clipName: 'extra',
                    clipTo: function(ctx) {
                        return _.bind(clipByName, logo)(ctx)
                    }
                });
                canvas.add(logo);
                canvas.moveTo(logo, 120);
            };
            tempImg.src = img03URL;



        };

    };




</script>
</body>
</html>